// Axon UMKM Multi-tenant Marketplace Schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id          String    @id @default(cuid())
    email       String    @unique
    password    String?
    name        String?
    whatsapp    String?
    googleId    String?   @unique
    image       String?
    gender      String? // "LAKI_LAKI", "PEREMPUAN"
    dateOfBirth DateTime?
    address     String? // Alamat domisili user
    role        Role      @default(USER)

    // Relations
    shopId    String?   @unique
    shop      Shop?     @relation(fields: [shopId], references: [id])
    addresses Address[]

    createdAt     DateTime       @default(now())
    updatedAt     DateTime       @updatedAt
    orders        Order[]
    notifications Notification[]
}

model Address {
    id           String  @id @default(cuid())
    userId       String
    label        String // Rumah, Kantor, Toko
    receiverName String
    phone        String
    street       String
    city         String
    province     String
    postalCode   String
    latitude     Float? // Koordinat untuk hitung ongkir
    longitude    Float?
    isMain       Boolean @default(false)

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Shop {
    id                  String     @id @default(cuid())
    name                String
    slug                String     @unique // For axonumkm.id/slug
    description         String?
    logo                String?
    address             String?
    latitude            Float? // For location-based search
    longitude           Float? // For location-based search
    maxDeliveryDistance Float      @default(5) // In km, default 5km
    balance             Decimal    @default(0) @db.Decimal(20, 2)
    commissionRate      Float      @default(0.05) // Default 5%
    isOpen              Boolean    @default(true)
    paymentMethods      String[]   @default([]) // Array of payment method codes (e.g. ["cod", "transfer"])
    status              ShopStatus @default(PENDING)

    owner    User?
    products Product[]
    orders   Order[]

    createdAt DateTime   @default(now())
    updatedAt DateTime   @updatedAt
    stockLogs StockLog[]
}

enum ShopStatus {
    PENDING
    ACTIVE
    SUSPENDED
}

model Category {
    id       String    @id @default(cuid())
    name     String    @unique // Sayur Mateng, Frozen, Jamu
    slug     String    @unique
    products Product[]
}

model Product {
    id         String  @id @default(cuid())
    shopId     String
    categoryId String?
    name       String
    slug       String? // Make optional initially or unique per shop? 
    // User requested unique globally: slug String @unique. But for multi-tenant, might be tricky. 
    // User schema showed: slug String @unique. I'll follow that but it might collide.
    // Actually, better uniqueness is per shop usually, but let's stick to user request `slug String @unique`.
    // Wait, user request for Product model: `slug String @unique`.

    description String? @db.Text
    price       Decimal @db.Decimal(20, 2)
    stock       Int     @default(0)
    weight      Int     @default(0) // Dalam gram
    // unit        String  @default("pcs") // REMOVED in favor of relation
    unitId      String?
    unit        Unit?   @relation(fields: [unitId], references: [id])

    // Atribut Fleksibel
    isPreOrder Boolean   @default(false) // Untuk Sayur Mateng
    expiryInfo String? // Contoh: "Tahan 2 hari suhu ruang"
    expiresAt  DateTime? // Waktu kadaluarsa spesifik (untuk auto-stock 0)
    condition  String    @default("NEW") // NEW, USED

    status   ProductStatus @default(ACTIVE)
    isActive Boolean       @default(true) // Keep backward compat or map to status

    shop      Shop             @relation(fields: [shopId], references: [id])
    category  Category?        @relation(fields: [categoryId], references: [id])
    images    ProductImage[]
    variants  ProductVariant[] // Untuk variasi rasa Jamu/Frozen
    stockLogs StockLog[] // Log perubahan stok (termasuk expired)

    trackStock Boolean     @default(true) // Whether to track/decrement stock for this product
    createdAt  DateTime    @default(now())
    updatedAt  DateTime    @updatedAt
    orderItems OrderItem[]

    // Custom unique constraint if needed, but user asked for @unique on slug
    @@unique([shopId, slug]) // Composite might be safer for "my-product" in different shops
}

model StockLog {
    id       String @id @default(cuid())
    quantity Int // Jumlah perubahan (negatif untuk pengurangan)
    type     String // "EXPIRED", "SALE", "RESTOCK", "ADJUSTMENT"

    productId String
    product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    shopId String
    shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
}

model ProductImage {
    id        String  @id @default(cuid())
    productId String
    url       String
    isPrimary Boolean @default(false)
    product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductVariant {
    id         String  @id @default(cuid())
    productId  String
    name       String // Contoh: "Rasa", "Ukuran"
    value      String // Contoh: "Pedas", "500ml"
    extraPrice Decimal @default(0) @db.Decimal(20, 2)
    product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Unit {
    id       String    @id @default(cuid())
    name     String    @unique
    products Product[]
}

model Order {
    id              String      @id @default(cuid())
    userId          String
    user            User        @relation(fields: [userId], references: [id])
    shopId          String
    shop            Shop        @relation(fields: [shopId], references: [id])
    items           OrderItem[]
    totalAmount     Decimal     @db.Decimal(20, 2)
    paymentMethod   String // bank_transfer, e_wallet, etc
    paymentStatus   String      @default("pending") // pending, paid, failed, expired
    shippingAddress Json? // Simpan sebagai JSON untuk fleksibilitas
    notes           String?

    commission Decimal @db.Decimal(20, 2) // Amount taken by platform
    netAmount  Decimal @db.Decimal(20, 2) // Amount earned by tenant

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
    @@index([shopId])
    @@index([paymentStatus])
    @@index([createdAt])
}

model OrderItem {
    id        String  @id @default(cuid())
    orderId   String
    order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
    productId String
    product   Product @relation(fields: [productId], references: [id])
    quantity  Int
    price     Decimal @db.Decimal(20, 2) // Harga saat checkout (snapshot)
    subtotal  Decimal @db.Decimal(20, 2)

    @@unique([orderId, productId])
    @@index([productId])
}

enum Role {
    USER
    ADMIN
    SELLER
}

enum ProductStatus {
    ACTIVE
    INACTIVE
    ARCHIVED
}

enum Condition {
    NEW
    USED
}

model Notification {
    id        String   @id @default(cuid())
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    title     String
    body      String
    type      String // "order_update", "new_order", etc.
    isRead    Boolean  @default(false)
    link      String? // e.g. "/dashboard/orders/abc123"
    createdAt DateTime @default(now())

    @@index([userId])
    @@index([isRead])
}
